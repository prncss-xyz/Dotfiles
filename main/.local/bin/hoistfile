#!/usr/bin/env sh

# TODO hoist theme

if [ -z "$DOTFILES" ]; then
	echo DOTFILES variable expected to be set
	exit 1
fi
PAC="$1"
if [ -z "$PAC" ]; then
	echo package name expected
	exit 1
fi

if [ ! -d "$DOTFILES/$PAC/.config/stow/active/$PAC" ]; then
	mkdir -p "$DOTFILES/$PAC/.config/stow/active"
	touch "$DOTFILES/$PAC/.config/stow/active/$PAC"
fi

if [ -z "$2" ]; then
	exit 0
fi
if [ ! -f "$2" ]; then
	echo file does not exist
	exit 1
fi
ABS=$(realpath "$2")
DIR=$(dirname "$ABS")

if [ "$DIR" = "$DOTFILES" ]; then
	echo "not part of a package"
	exit 1
fi

REL=$(realpath --relative-base="$DOTFILES" "$ABS")
case "$REL" in
/*) ;;
*)
	tail="${REL#*/}"
	# head="${REL%/$tail}"
	mv "$ABS" "$DOTFILES/$PAC/$tail"
	stow "$PAC"
	echo "$DOTFILES/$PAC/$tail"
	exit 0
	;;
esac

REL=$(realpath --relative-base="$HOME" "$DIR")
case "$REL" in
/*) ;;

*)
	mkdir -p "$DOTFILES/$PAC/$REL"
	mv "$ABS" "$DOTFILES/$PAC/$REL"
	stow "$PAC"
	echo "$DOTFILES/$PAC/$REL"
	exit 0
	;;
esac

mkdir -p "$DOTFILES/$PAC/.config/stow/sysfiles/$DIR"
if [ -f "$ABS" ]; then
	cp "$ABS" "$DOTFILES/$PAC/.config/stow/sysfiles/$DIR"
fi
stow "$PAC"
