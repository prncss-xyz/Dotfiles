#!/bin/env sh

if [ "$1" = "--last" ]; then
	if [ ! -f /tmp/ttt-last ]; then
    echo "no last file" > /dev/stderr
		exit 1
	fi
	inp="$(cat /tmp/ttt-last)"
else
	inp="$1"
fi
source=$(realpath "$inp")
if [ ! -e "$source" ]; then
  echo "'$1' doest not exists"  > /dev/stderr
  exit 1
fi

FPATH="$inp"
FNAME=$(basename "$inp")
ext="${FNAME##*.}"
if [ -n "$ext" ]; then
	ext="$(printf "%s" "${ext}" | tr '[:upper:]' '[:lower:]')"
fi

case "${ext}" in
md | markdown)
	cd "$(xdg-user-dir DOCUMENTS)" || exit 1
	history=text
	;;

htm | html)
	cd "$(xdg-user-dir DOCUMENTS)" || exit 1
	history=text
	;;

## text
pdf | doc | docx | epub)
	cd "$(xdg-user-dir DOCUMENTS)" || exit 1
	history=text
	;;


## Ebook
azw3)
	cd "$(xdg-user-dir DOCUMENTS)" || exit 1
	history=text
	;;

jpg | jpeg)
	cd "$(xdg-user-dir PICTURES)" || exit 1
	history=pictures
	;;
esac

MIMETYPE="$(file -bL --mime-type -- "${FPATH}")"
case "${MIMETYPE}" in
inode/x-empty)
	exit 2
	;;

## DjVu
image/vnd.djvu)
	cd "$(xdg-user-dir DOCUMENTS)" || exit 1
	history=text
	;;

## Image
image/*)
	cd "$(xdg-user-dir PICTURES)" || exit 1
	history=pictures
	;;

## Text/html
text/html)
	cd "$(xdg-user-dir DOCUMENTS)" || exit 1
	history=text
	;;

## PDF
application/pdf)
	cd "$(xdg-user-dir DOCUMENTS)" || exit 1
	history=text
	;;

## Ebook
application/vnd.openxmlformats-officedocument.wordprocessingml.document | \
	application/x-mobipocket-ebook | \
	application/epub+zip)
	cd "$(xdg-user-dir DOCUMENTS)" || exit 1
	history=text
	;;

## Text
text/*)
	cd "$(xdg-user-dir DOCUMENTS)" || exit 1
	history=text
	;;

## Audio
audio/*)
	cd "$(xdg-user-dir MUSIC)" || exit 1
	history=audio
	;;

## Video
video/*)
	cd "$(xdg-user-dir VIDEOS)" || exit 1
	history=videos
	;;
esac
if [ -z "$history" ]; then
	exit 4
fi

mkdir -p "$HOME"/.histories/
if [ ! -f "$HOME"/.histories/$history ]; then
	touch "$HOME"/.histories/$history
fi
result="$(fd -t d -x echo '{}' | fzf --history="$HOME"/.histories/$history --print-query | tail -1)"
if [ -n "$result" ]; then
	mkdir -p "$result"
	mv "$source" "$result"
	echo "$PWD/$result/$FNAME" >/tmp/ttt-last
fi
