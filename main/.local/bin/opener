#!/usr/bin/env sh

# TODO http://

FPATH="$1"

case "${FPATH}" in
  http://*|https://*)
    browser "${FPATH}" &
    exit 0
    ;;
esac

#TODO: epub, office

FNAME=$(basename "$1")
DNAME=$(dirname "$1")
EDITOR="${VISUAL:-${EDITOR:-vi}}"
PAGER="${PAGER:-less -R}"
ext="${FNAME##*.}"
if [ -n "$ext" ]; then
  ext="$(printf "%s" "${ext}" | tr '[:upper:]' '[:lower:]')"
fi

case "${ext}" in
  md|markdown)
    mdopen "${FPATH}" &
    exit 0
    ;;
  htm|html)
    browser "${FPATH}" &
    exit 0
    ;;
    ## text
  txt|jsx|tsx)
    nvr --remote-silent "${FPATH}"
    exit 0
    ;;
esac

MIMETYPE="$( file -bL --mime-type -- "${FPATH}" )"
case "${MIMETYPE}" in
  inode/x-empty)
  nvr --remote-silent "${FPATH}"
  exit 0
  ;;

  ## Image
  image/*)
  imv -n "${FPATH}" "${DNAME}" &
  exit 0
  ;;

  ## Manpages
  text/troff)
  hman -l "${FPATH}"
  exit 0
  ;;

  ## Text/html
  text/html)
  browser "${FPATH}" &
  exit 0
  ;;

  ## PDF
  application/pdf)
  browser "${FPATH}" &
  # evince "${FPATH}" &
  exit 0
  ;;

  ## Audio
  audio/*)
  celluloid "${FPATH}" &
  exit 0
  ;;

  ## Video
  video/*)
  celluloid "${FPATH}" &
  exit 0
  ;;

  ## Ebook
  application/vnd.openxmlformats-officedocument.wordprocessingml.document| \
    application/x-mobipocket-ebook| \
    application/epub+zip)
      ebook-viewer "${FPATH}" &
      exit 0
      ;;

  ## Text
  ## TODO new kitty if no remote
  text/* | */xml | */json)
  nvr --remote-silent "${FPATH}"
  exit 0
  ;;

  ## DjVu
  image/vnd.djvu)
  if which djvutxt >/dev/null 2>&1; then
    ## Preview as text conversion (requires djvulibre)
    djvutxt "${FPATH}" | eval "$PAGER"
    exit 0
  elif which exiftool >/dev/null 2>&1; then
    exiftool "${FPATH}" | eval "$PAGER"
    exit 0
  fi
  exit 1
  ;;
esac
echo unknown mimetype $MIMETYPE
