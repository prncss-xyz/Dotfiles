#!/usr/bin/env sh

# Binary file: show file info inside the pager
print_bin_info() {
  printf -- "-------- \033[1;31mBinary file\033[0m --------\n"
  if exists mediainfo; then
    mediainfo "$1" 2>/dev/null
  else
    file -b "$1"
  fi
}

exists() {
    which "$1" >/dev/null 2>&1
}

encoding="$(file -Lb --mime-encoding -- "$1")"
mimetype="$(file -Lb --mime-type -- "$1")"
ext="${1##*.}"
if [ -n "$ext" ]; then
  ext="$(printf "%s" "${ext}" | tr '[:upper:]' '[:lower:]')"
fi
lines=$(($(tput lines)-1))
cols=$(tput cols)

#TODO: epub, office

FNAME=$(basename "$1")
DNAME=$(dirname "$1")
EDITOR="${VISUAL:-${EDITOR:-vi}}"
PAGER="${PAGER:-less -R}"
ext="${FNAME##*.}"
if [ -n "$ext" ]; then
  ext="$(printf "%s" "${ext}" | tr '[:upper:]' '[:lower:]')"
fi

if [ -d "$1" ]; then
  cd "$1" || return
  if exists tree; then
    tree -L 3 -F
  elif exists exa; then
    exa -G --colour=always 2>/dev/null
  else
    ls --color=always
  fi
elif [ "$encoding" = "binary" ]; then
  if [ "${mimetype%%/*}" = "image" ] ; then
    if [ "$TERMINAL" = "kitty" ]; then
      # Kitty terminal users can use the native image preview method.
      kitty +kitten icat --silent --transfer-mode=stream --stdin=no \
        "$1" &
     elif exists catimg; then
            catimg "$1"
            elif exists viu; then
              viu -t "$1"
            else
              print_bin_info "$1"
    fi
  elif [ "$mimetype" = "application/pdf" ] ; then
    pdftotext "$1" -
  elif [ "$mimetype" = "application/zip" ] ; then
    unzip -l "$1"
  elif [ "$ext" = "gz" ] || [ "$ext" = "bz2" ] ; then
    tar -tvf "$1"
  else
    print_bin_info "$1"
  fi
elif [ "$mimetype" = "text/troff" ] ; then
  man -Pcat -l "$1"
elif [ "$mimetype" = "text/html" ] ; then
  w3m "$1"
else
  if exists bat; then
    bat --terminal-width="$cols" --paging=never --decorations=always --color=always \
      --style=changes,header,rule,snip "$1" 2>/dev/null
        else
          cat "$1"
  fi
fi
