#!/usr/bin/env bash

set -e

name="${1-rose-pine}"
export DEST="$DOTFILES/_template"

# dir dir/name.ext dir/name.ext.esh
step() {
	mkdir -p "$DEST-new/$1"
  envsubst < "$HOME/.config/stow/theming/$3/$2" > "$DEST-new"/"$2"
}
export -f step

source ~/.config/stow/theming/generated/"$name".sh
export HOSTNAME="${HOSTNAME-$hostname}"

export text="$foreground"
export accent="$color6"
export primary="$color12"
export font="Montserrat"

# passing these vars unexpended
export $WOBSOCK='$WOBSOCK'

source "$HOME/.config/stow/theming/extra/$name".sh

fd -H --type l --base-directory ~/.config/stow/theming/skeleton -x sh -c 'step {//} {} skeleton'
if [ -d "$HOME/.config/stow/theming/specific/$name" ]; then
	fd -H --type l --base-directory "$HOME/.config/stow/theming/specific/$name" -x sh -c "step {//} {} specific/$name"
fi

stow -D _template
rm -rf "$DEST"-old
if [ -d "$DEST" ]; then
  mv "$DEST" "$DEST"-old
fi
mv "$DEST"-new "$DEST"
stow _template

~/Dotfiles/main/.local/bin/setbg-sway
